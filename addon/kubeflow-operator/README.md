# KubeFlow Addon for Kubermatic Kubernetes Platform
This is a KubeFlow [addon for Kubermatic Kubernetes Platform](https://docs.kubermatic.com/kubermatic/master/advanced/addons/).

The KubeFlow addon provides the following optional config options:
- `EnableTLS` (boolean): If true, TLS will be enabled, and a certificate will be automatically issued for the specified `DomainName`.
- `DomainName` (text): Domain name that will be used to access the KubeFlow dashboard. Make sure to set up you DNS accordingly.
- `IstioIngressGatewayServiceType` (text): Type of the istio-ingressgateway service, used to access KubeFlow dashboard. It can be set to `ClusterIP`, `NodePort` or `LoadBalancer`.
- `OIDCProviderURL` (text): URL of external OIDC provider, e.g. Kubermatic Dex instance. Make sure that `DomainName` is specified if you are using this. If not provided, static user authentication will be used.
- `OIDCSecret` (text): Secret string shared between the OIDC provider and KubeFlow. If not provided, [this default](https://github.com/kubeflow/manifests/blob/master/istio/oidc-authservice/base/params.env#L5) is used (insecure!).

## Example Addon Resources
For the KubeFlow addon:
```yaml
apiVersion: kubermatic.k8s.io/v1
kind: Addon
metadata:
  name: kubeflow-operator
  namespace: cluster-bjg9qmhctj
  ownerReferences:
  - apiVersion: kubermatic.k8s.io/v1
    blockOwnerDeletion: true
    controller: true
    kind: Cluster
    name: bjg9qmhctj
    uid: 30c13f8b-235e-4512-8673-d9b0f3a41f27
spec:
  cluster:
    kind: Cluster
    name: bjg9qmhctj
    uid: 30c13f8b-235e-4512-8673-d9b0f3a41f27
  name: kubeflow-operator
  variables:
    {
      "DomainName": "kubeflow.mydomain.io",
      "IstioIngressGatewayServiceType": "LoadBalancer",
      "OIDCProviderURL": "https://dev.kubermatic.io/dex",
      "OIDCSecret": "NQh4P9fIDlEyI6EMKW66TLKLdcIStT4C02"
    }
```

## OIDC Provider Configuration
The plugin allows pointing to an external OIDC provider of user's choice. To have OIDC working, the provider itself needs to be configured as well - e.g. in case it is a Dex instance, a `staticClients` entry needs to be added:
```yaml
  staticClients:
    - RedirectURIs:
        - http://kubeflow.mydomain.io/login/oidc
      id: kubeflow-oidc-authservice
      name: kubeflow-oidc-authservice
      secret: NQh4P9fIDlEyI6EMKW66TLKLdcIStT4C02
```

## TLS Configuration
If TLS is enabled, the addon will automatically issue a certificate for the specified `DomainName` using cert-manager and Let's Encrypt ACME. However, due to some Istio-related issues, the Istio configuration needs to be manually adapted with a new `Gateway` and `VirtualService` to let ACME challenge pass to the solver pods. Once the certificate is successfully issued, these can be removed.

### Example Gateway:
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: challenge
  namespace: kubeflow
spec:
  selector:
    istio: ingressgateway
  servers:
  - hosts:
    - '*'
    port:
      name: http
      number: 80
      protocol: HTTP
```

### Example VirtualService:
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: challenge
  namespace: kubeflow
spec:
  gateways:
  - challenge
  hosts:
  - 'kubeflow.mydomain.io'
  http:
  - match:
    - method:
        exact: GET
      uri:
        prefix: /.well-known/acme-challenge/PQILQ5DARUGg0woJ19lLhNfU-HThRNndmb_epggYv78
    route:
    - destination:
        host: cm-acme-http-solver-frnh4.istio-system.svc.cluster.local
        port:
          number: 8089
```

## Addon Maintenance
The manifest.yaml file contains three parts:
- A namespace to deploy KubeFlow operator.
- Manifest of KubeFlow operator, which can be generated by following [KubeFlow operator page](https://github.com/kubermatic/kfctl/blob/master/operator.md#deployment-instructions)
- A KfDef which is used to config KubeFlow installation.
